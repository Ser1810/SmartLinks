name: .NET

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout репозитория
        uses: actions/checkout@v3

      - name: Установить Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Собрать и запустить контейнеры
        run: |
          docker-compose up --build -d

      - name: Запустить тесты внутри контейнера
        run: |
          docker-compose run --rm test

      - name: Остановить контейнеры
        run: |
          docker-compose down

      - name: Найти отчет о покрытии
        id: find_report
        run: |
          # Путь к отчету, который монтируется из контейнера
          REPORT_PATH="./TestResults/coverage.cobertura.xml"
          
          if [ ! -f "$REPORT_PATH" ]; then
            echo "Отчет не найден по пути $REPORT_PATH"
            exit 1
          fi
          
          echo "report_path=$REPORT_PATH" >> $GITHUB_OUTPUT

      - name: Установить xmlstarlet для парсинга XML
        if: steps.find_report.outputs.report_path != ''
        run: |
          sudo apt-get install -y xmlstarlet

      - name: Парсить и выводить процент покрытия
        if: steps.find_report.outputs.report_path != ''
        run: |
          REPORT_FILE="${{ steps.find_report.outputs.report_path }}"
          
          LINE_RATE=$(xmlstarlet sel -t -v "/coverage/@line-rate" "$REPORT_FILE")
          
          PERCENTAGE=$(awk "BEGIN {printf \"%.2f\", $LINE_RATE * 100}")
          
          echo "Процент покрытия кода тестами: $PERCENTAGE%"